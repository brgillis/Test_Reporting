# TD-SHE-000012-calibr-simul

## Summary

This testing dataset comprises the data needed for a run of the SHE Sensitivity Testing programme, which constitutes the execution of the T-SHE-000012-calibr-simul test case. This programme consists of runs of the SHE Shear Calibration pipeline, which creates most of the data it needs for execution on-the-fly, and so the input data described here includes the configuration datafiles which describe how this data is to be produced. 

## Relevant Tests and Test Cases

* T-SHE-000012-calibr-simul

## Data Details

All data products in this testing dataset is stored in the Euclid Archive Service (EAS), and can be viewed on the DBView web service (https://eas-dps-cus-ops.esac.esa.int/) or retrieved via the DataProductRetrieval.py script through querying it appropriately.

The following sections list the different types of data products required, plus the metadata values which can be used to query for them. In addition to the metadata values listed below, all queries should include ``Header.ManualValidationStatus.ManualValidationStatus!="INVALID"`` to properly exclude any invalidated data.

### Data from PF-SHE - Data Products

The following data products are used, which are generated manually with PF-SHE to be used as input to the SHE Analysis pipeline:

* DpdSheKsbTraining
  * `Header.ProductId.ObjectId=2dba6df3-e4cb-4aad-b98a-e1126c7d431f`
* DpdSheLensMcTraining
  * `Header.ProductId.ObjectId=7b213d33-6c34-4a38-8523-e7ceba50411e`
* DpdSheRegaussTraining
  * `Header.ProductId.ObjectId=f97e9592-175d-4571-be14-a1eb783920d8`
* DpdSheBFDTraining
  * `Header.ProductId.ObjectId=1559052024.257727`
  * **Note:** This product is now deprecated, and is no longer stored in the EAS as the instance used for this testing campaign is not compatible with the current datamodel. 

Each of these products aside from DpdSheBFDTraining can be retrieved with the corresponding `Header.ProductId.ObjectId` valued listed above. Note that this testing campaign was performed on an older version of the Euclid Data model, and the versions now available on the EAS are migrated instances of the original products which contain the same scientific data.

### Data from PF-SHE - Other Data

In this section, we detail the configuration and other data used to detail the nature of the simulations generated by the SHE Shear Calibration pipeline. This data is all stored within the auxiliary directories of PF-SHE projects: `SHE_GST` which handles simulations, and `SHE_IAL_Pipelines`, which handles pipeline control. This directory is version-controlled, and so the version used for this testing campaign will be linked.

#### Template Simulation Configuration Files

**Location:** https://gitlab.euclid-sgs.uk/PF-SHE/SHE_GST/-/tree/master/SHE_GST_PrepareConfigs/auxdir/SHE_GST_PrepareConfigs

**Purpose:** A template simulation file to describe parameters that will be fixed throughout the entirety of a single simulation run. Multiple templates with parameters set to different values are used for separate runs of the SHE Shear Calibration pipeline, and the resulting biases are compared to calculate the sensitivity of shear bias to the change in the input parameter.

**Description:** This set of template configuration files contains one file containing fiducial values for all parameters (`SensitivityEp0Pp0Sp0Template.conf`), and a set of four files varying each parameter of interest in this testing campaign both below and above the fiducial value. These are, for each parameter:

Varying intrinsic galaxy ellipticity:
* `SensitivityEm2Pp0Sp0Template.conf`
* `SensitivityEm1Pp0Sp0Template.conf`
* `SensitivityEp1Pp0Sp0Template.conf`
* `SensitivityEp2Pp0Sp0Template.conf`

Varying sky background level:
* `SensitivityEp0Pp0Sm2Template.conf`
* `SensitivityEp0Pp0Sm1Template.conf`
* `SensitivityEp0Pp0Sp1Template.conf`
* `SensitivityEp0Pp0Sp2Template.conf`

Varying galaxy disk truncation radius:
* `SensitivityTm2Template.conf`
* `SensitivityTm1Template.conf`
* `SensitivityTp1Template.conf`
* `SensitivityTp2Template.conf`

Varying PSF by adjusting the simulated position of the M2 mirror:
* `Sensitivity_PSF_Pm2.conf`
* `Sensitivity_PSF_Pm1.conf`
* `Sensitivity_PSF_Pp1.conf`
* `Sensitivity_PSF_Pp2.conf`

Varying PSF size through linear scaling:
* `Sensitivity_PSF_Lm2.conf`
* `Sensitivity_PSF_Lm1.conf`
* `Sensitivity_PSF_Lp1.conf`
* `Sensitivity_PSF_Lp2.conf`

Varying PSF shape through a shear transformation:
* `Sensitivity_PSF_Sm2.conf`
* `Sensitivity_PSF_Sm1.conf`
* `Sensitivity_PSF_Sp1.conf`
* `Sensitivity_PSF_Sp2.conf`

#### Control Scripts

**Location:** https://gitlab.euclid-sgs.uk/PF-SHE/SHE_IAL_Pipelines/-/tree/master/SHE_Pipeline/scripts

**Purpose:** The SHE Shear Calibration pipeline takes a simulation plan configuration file as input, which details how many simulations of how many galaxies each are to be run. In the context of the Sensitivity Testing programme, which performs the validation tests here, this is generated through use of control scripts which request a series of simulations, each simulating a single image containing 16 galaxies in individual postage stamps.

**Description:** Each control script (such as `call_psf_sensitivity_testing_cambridge.sh`) requests simulations of the same nature, varying only in the input seed values used for random number generation and in parameters relating to the architecture on which a batch of simulations is run. The scripts are set up to submit a series of pipeline runs, check for completion, and re-run any failed runs until the full set is complete. This process is manually monitored to add scripts for more runs if computing resources are available.

Due to uncertainties in the magnitude of the sensitivity value and the error in it, the needed amount of data was not known upfront. The programme was monitored, and, when the results were found to be statistically significant enough, the programme was halted. As such, the seed values in these control scripts do not relate exactly to the final amount of data used, as the programme was halted before they could all complete. The final volume for this analysis was ~4x10^6 simulated galaxies per tested parameter value, or ~1x10^8 total simulated galaxies.

#### Model PSFs

**Location:** https://gitlab.euclid-sgs.uk/PF-SHE/SHE_GST/-/tree/master/SHE_GST_GalaxyImageGeneration/auxdir/SHE_GST_GalaxyImageGeneration/psf_models

**Purpose:** As part of testing sensitivity to input PSF, PSF models were needed fitting the desired variation. These models were precomputed and stored in the `SHE_GST` project's auxdir for use in the simulations.

**Description:**

The following precomputed PSF images were used, each pointed to by the corresponding template simulation configuration files listed above:

Fiducial (used with `SensitivityEp0Pp0Sp0Template.conf` and all which vary some parameter othen than the PSF):
* sensitivity_testing_psf_p0.fits

Varying PSF by adjusting the simulated position of the M2 mirror:
* sensitivity_testing_psf_m2.fits
* sensitivity_testing_psf_m1.fits
* sensitivity_testing_psf_p1.fits
* sensitivity_testing_psf_p2.fits

Varying PSF size through linear scaling:
* sensitivity_testing_psf_linear_m2.fits
* sensitivity_testing_psf_linear_m1.fits
* sensitivity_testing_psf_linear_p1.fits
* sensitivity_testing_psf_linear_p2.fits

Varying PSF shape through a shear transformation:
* sensitivity_testing_psf_shear_m2.fits
* sensitivity_testing_psf_shear_m1.fits
* sensitivity_testing_psf_shear_p1.fits
* sensitivity_testing_psf_shear_p2.fits

